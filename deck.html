<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>D&D Draw Deck</title>
  <style>
    :root{
      --bg1:#0b0f19; --bg2:#141a2a;
      --card:#f6f6f6; --ink:#111; --muted:rgba(17,17,17,.62);
      --glass: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.14);
      --shadow: rgba(0,0,0,.42);
      --ring: rgba(255,255,255,.18);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1100px 780px at 18% 12%, rgba(60,120,255,.16), transparent 58%),
        radial-gradient(1000px 700px at 78% 22%, rgba(190,90,255,.12), transparent 55%),
        radial-gradient(900px 640px at 50% 92%, rgba(80,200,140,.10), transparent 56%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 22px;
    }

    .wrap{ width:min(980px, 100%); }
    .top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:14px;
    }
    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      opacity:.94;
    }
    .brand .sub{
      font-size:12px;
      opacity:.72;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }
    button{
      border:1px solid var(--ring);
      border-radius: 12px;
      padding: 10px 14px;
      background: var(--glass);
      color:#fff;
      cursor:pointer;
      box-shadow: 0 14px 40px var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform .06s ease, background .12s ease;
    }
    button:hover{ background: var(--glass2); }
    button:active{ transform: translateY(1px); }

    .toggle{
      display:flex; align-items:center; gap:8px;
      font-size:13px; opacity:.92;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid var(--ring);
      background: rgba(255,255,255,.07);
      box-shadow: 0 14px 40px var(--shadow);
    }
    .toggle input{ transform: translateY(1px); }

    .grid{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(244,244,244,.98));
      color: var(--ink);
      border-radius: 18px;
      padding: 16px 16px 14px;
      box-shadow: 0 24px 70px rgba(0,0,0,.52);
      border: 2px solid rgba(0,0,0,.10);
      overflow:hidden;
      position:relative;
      min-height: 210px;
    }
    .card::before{
      content:"";
      position:absolute; inset:-40% -40%;
      background: radial-gradient(circle at 22% 18%, rgba(120,80,255,.16), transparent 56%),
                  radial-gradient(circle at 76% 22%, rgba(80,200,140,.12), transparent 55%);
      transform: rotate(8deg);
      pointer-events:none;
    }

    .raritybar{
      height:7px;
      border-radius:999px;
      background: rgba(0,0,0,.10);
      overflow:hidden;
      margin-bottom: 12px;
      position:relative;
      z-index:1;
    }
    .rarityfill{
      height:100%;
      width:100%;
      transform-origin:left;
      transform: scaleX(0);
      transition: transform .18s ease-out;
    }

    .titleRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      margin-bottom: 8px;
      position:relative;
      z-index:1;
    }
    .title{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .pill{
      font-size: 12px;
      padding: 4px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.12);
      white-space:nowrap;
    }
    .body{
      font-size: 15px;
      line-height: 1.5;
      position:relative;
      z-index:1;
      padding-top: 6px;
      padding-bottom: 6px;
    }
    .footer{
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      border-top: 1px dashed rgba(0,0,0,.20);
      padding-top: 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }

    .panel{
      border:1px solid var(--ring);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 14px 40px var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .panel h2{
      margin:0 0 10px 0;
      font-size: 13px;
      letter-spacing:.3px;
      text-transform: uppercase;
      opacity:.85;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    select, input[type="text"]{
      border:1px solid var(--ring);
      background: rgba(255,255,255,.08);
      color:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      width: 100%;
    }
    select option{ color:#111; }
    .meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      font-size: 12px;
      opacity:.85;
      margin-top: 10px;
    }
    .meta span{
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--ring);
      background: rgba(255,255,255,.06);
    }

    ul.history{
      list-style:none;
      margin: 10px 0 0 0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 320px;
      overflow:auto;
    }
    ul.history li{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .hTitle{ font-weight: 800; font-size: 13px; margin-bottom: 3px; }
    .hSub{ font-size: 12px; opacity:.75; }
    .hint{
      font-size: 12px;
      opacity:.70;
      margin-top: 10px;
    }

    .pop{ animation: pop .16s ease-out; }
    @keyframes pop{ from{ transform: scale(.988); } to{ transform: scale(1); } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>D&D Random Draw</h1>
        <div class="sub">Click Draw to “pull a card” from your pool.</div>
      </div>
      <div class="controls">
        <button id="drawBtn">Draw</button>
        <button id="copyBtn" title="Copy the current result to clipboard">Copy</button>
        <button id="resetBtn">Reset</button>
        <label class="toggle"><input id="noRepeats" type="checkbox" checked> No repeats</label>
      </div>
    </div>

    <div class="grid">
      <!-- Main card -->
      <div id="card" class="card">
        <div class="raritybar"><div id="rarityFill" class="rarityfill"></div></div>
        <div class="titleRow">
          <div id="title" class="title">Ready.</div>
          <div id="tag" class="pill">Deck</div>
        </div>
        <div id="body" class="body">Press <b>Draw</b> to get a result.</div>
        <div class="footer">
          <div>Remaining: <span id="remaining">—</span></div>
          <div>Filter: <span id="activeFilter">All</span></div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="panel">
        <h2>Options</h2>

        <div class="row" style="margin-bottom:10px;">
          <div style="width:100%;">
            <div style="font-size:12px;opacity:.78;margin-bottom:6px;">Category filter</div>
            <select id="category"></select>
          </div>
        </div>

        <div class="row" style="margin-bottom:6px;">
          <div style="width:100%;">
            <div style="font-size:12px;opacity:.78;margin-bottom:6px;">Search (optional)</div>
            <input id="search" type="text" placeholder="e.g. omen, curse, goblin..." />
          </div>
        </div>

        <div class="meta">
          <span id="totalMeta">Total: —</span>
          <span id="modeMeta">Mode: —</span>
        </div>

        <h2 style="margin-top:14px;">History</h2>
        <ul id="history" class="history"></ul>

        <div class="hint">
          Edit the <b>DATA</b> array in this file to add your own entries.
          You can use it for rumors, omens, loot quirks, encounters, etc.
        </div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // 1) EDIT YOUR DATA HERE
  // =========================
  // Tip: keep "id" unique.
  const DATA = [
    {
      id: "omen_whisper",
      title: "Whisper in the Walls",
      category: "Omen",
      body: "You hear your name from the next room in a voice you trust. Gain advantage on your next Insight check, but take -1 on your next Wisdom save.",
      footer: "DM: you may reveal a vague clue about the next room.",
      rarity: "common"
    },
    {
      id: "curse_ashes",
      title: "Ashes on the Wind",
      category: "Curse",
      body: "Gray ash clings to your fingers. The next creature you touch feels cold dread. The DM gains 1 doom token.",
      footer: "Remove with Remove Curse or a full night’s sleep.",
      rarity: "rare"
    },
    {
      id: "loot_coin",
      title: "A Coin That Won’t Spend",
      category: "Loot",
      body: "You find an old coin stamped with a king nobody recognizes. Merchants refuse it… but collectors might pay double.",
      footer: "Worth 2× in the right place.",
      rarity: "uncommon"
    },
    {
      id: "rumor_lighthouse",
      title: "The Lighthouse That Isn’t There",
      category: "Rumor",
      body: "Locals swear they’ve seen a lighthouse beam on moonless nights—yet maps show no coast for miles.",
      footer: "If you investigate, the DM adds a secret location to the world.",
      rarity: "common"
    }
  ];

  // Visual accents by rarity (you can rename rarities however you like)
  const RARITY_STYLE = {
    common:   { fill: "rgba(255,255,255,0)",   border: "rgba(0,0,0,.14)" },
    uncommon: { fill: "rgba(80,200,140,.75)",  border: "rgba(80,200,140,.45)" },
    rare:     { fill: "rgba(140,90,255,.78)",  border: "rgba(140,90,255,.45)" },
    legendary:{ fill: "rgba(255,170,60,.80)",  border: "rgba(255,170,60,.45)" },
  };

  // =========================
  // 2) APP STATE
  // =========================
  const STORAGE_KEY = "dd_draw_state_v1";

  let state = {
    remainingIds: [],   // for no-repeats mode
    historyIds: [],     // last -> first
    category: "All",
    search: ""
  };

  const el = {
    card: document.getElementById("card"),
    title: document.getElementById("title"),
    tag: document.getElementById("tag"),
    body: document.getElementById("body"),
    remaining: document.getElementById("remaining"),
    activeFilter: document.getElementById("activeFilter"),
    rarityFill: document.getElementById("rarityFill"),
    drawBtn: document.getElementById("drawBtn"),
    resetBtn: document.getElementById("resetBtn"),
    copyBtn: document.getElementById("copyBtn"),
    noRepeats: document.getElementById("noRepeats"),
    category: document.getElementById("category"),
    search: document.getElementById("search"),
    history: document.getElementById("history"),
    totalMeta: document.getElementById("totalMeta"),
    modeMeta: document.getElementById("modeMeta"),
  };

  function getById(id){ return DATA.find(x => x.id === id); }

  function categories(){
    const set = new Set(DATA.map(x => x.category).filter(Boolean));
    return ["All", ...Array.from(set).sort((a,b)=>a.localeCompare(b))];
  }

  function filteredData(){
    const cat = state.category;
    const q = (state.search || "").trim().toLowerCase();

    return DATA.filter(item => {
      if (cat !== "All" && item.category !== cat) return false;
      if (!q) return true;
      const hay = `${item.title} ${item.category} ${item.body} ${item.footer || ""}`.toLowerCase();
      return hay.includes(q);
    });
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      state,
      noRepeats: el.noRepeats.checked
    }));
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      const parsed = JSON.parse(raw);
      if(parsed?.state) state = parsed.state;
      if(typeof parsed?.noRepeats === "boolean") el.noRepeats.checked = parsed.noRepeats;
      return true;
    } catch {
      return false;
    }
  }

  function reshuffleRemainingFromCurrentFilter(){
    // Build remaining list from whatever is currently eligible
    const eligible = filteredData().map(x => x.id);
    state.remainingIds = [...eligible];
  }

  function initUI(){
    // fill category dropdown
    el.category.innerHTML = "";
    for(const c of categories()){
      const opt = document.createElement("option");
      opt.value = c; opt.textContent = c;
      el.category.appendChild(opt);
    }
    el.category.value = state.category || "All";
    el.search.value = state.search || "";
  }

  function updateMeta(){
    const eligibleCount = filteredData().length;
    el.totalMeta.textContent = `Eligible: ${eligibleCount}`;
    el.modeMeta.textContent = `Mode: ${el.noRepeats.checked ? "No repeats" : "Repeats OK"}`;

    el.activeFilter.textContent = state.category === "All" ? "All" : state.category;
    if ((state.search || "").trim()) el.activeFilter.textContent += ` + Search`;

    if (el.noRepeats.checked){
      // remaining is based on state.remainingIds, but it might include ids that no longer match filters
      const eligibleSet = new Set(filteredData().map(x=>x.id));
      const remainingEligible = state.remainingIds.filter(id => eligibleSet.has(id));
      el.remaining.textContent = `${remainingEligible.length} / ${eligibleSet.size}`;
    } else {
      el.remaining.textContent = "∞";
    }
  }

  function renderHistory(){
    el.history.innerHTML = "";
    const ids = state.historyIds.slice(0, 12);
    for(const id of ids){
      const item = getById(id);
      if(!item) continue;
      const li = document.createElement("li");
      li.innerHTML = `
        <div class="hTitle">${escapeHtml(item.title)}</div>
        <div class="hSub">${escapeHtml(item.category || "—")} • ${escapeHtml(item.rarity || "—")}</div>
      `;
      el.history.appendChild(li);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function setRarityStyle(rarity){
    const st = RARITY_STYLE[rarity] || RARITY_STYLE.common;
    el.rarityFill.style.background = st.fill;
    el.rarityFill.style.transform = "scaleX(1)";
    el.card.style.borderColor = st.border;
  }

  function renderCard(item){
    el.card.classList.remove("pop");
    void el.card.offsetWidth;
    el.card.classList.add("pop");

    el.title.textContent = item.title;
    el.tag.textContent = item.category || "Result";

    const footerText = item.footer ? `\n\n${item.footer}` : "";
    el.body.textContent = `${item.body}${footerText}`;

    setRarityStyle(item.rarity);
  }

  function draw(){
    const eligible = filteredData();
    if(eligible.length === 0){
      renderCard({
        title: "No matches",
        category: "Filter",
        body: "Your filter/search has no eligible items. Change the category or clear the search box.",
        footer: "",
        rarity: "common"
      });
      return;
    }

    if(!el.noRepeats.checked){
      // repeats allowed: pick from eligible
      const pick = eligible[Math.floor(Math.random() * eligible.length)];
      pushHistory(pick.id);
      renderCard(pick);
      save();
      updateMeta();
      renderHistory();
      return;
    }

    // no repeats: pick from remaining eligible
    const eligibleSet = new Set(eligible.map(x => x.id));

    // If remaining is empty or missing eligible items, rebuild it
    const remainingEligible = state.remainingIds.filter(id => eligibleSet.has(id));
    if(remainingEligible.length === 0){
      // "deck empty" for this filter — require reset or auto-reshuffle
      renderCard({
        title: "Pool empty (for this filter)",
        category: "Reset",
        body: "You’ve drawn everything in the current filtered pool. Hit Reset to reshuffle, or change the filter to draw from something else.",
        footer: "",
        rarity: "uncommon"
      });
      return;
    }

    const idx = Math.floor(Math.random() * remainingEligible.length);
    const pickedId = remainingEligible[idx];

    // Remove it from remainingIds
    state.remainingIds = state.remainingIds.filter(id => id !== pickedId);

    const picked = getById(pickedId);
    if(picked){
      pushHistory(picked.id);
      renderCard(picked);
    }
    save();
    updateMeta();
    renderHistory();
  }

  function pushHistory(id){
    state.historyIds.unshift(id);
    state.historyIds = Array.from(new Set(state.historyIds)).slice(0, 50); // unique, max 50
  }

  function reset(){
    // reset remaining based on current filter/search
    reshuffleRemainingFromCurrentFilter();
    state.historyIds = [];
    renderHistory();
    updateMeta();
    save();
    renderCard({
      title: "Reset complete",
      category: "Deck",
      body: "Your pool has been reshuffled for the current filter/search. Click Draw.",
      footer: "",
      rarity: "common"
    });
  }

  async function copyCurrent(){
    const text = `${el.title.textContent}\n${el.tag.textContent}\n\n${el.body.textContent}`;
    try{
      await navigator.clipboard.writeText(text);
      el.copyBtn.textContent = "Copied!";
      setTimeout(()=> el.copyBtn.textContent = "Copy", 900);
    } catch {
      alert("Couldn't copy automatically. Select the text on the page and copy manually.");
    }
  }

  // =========================
  // 3) WIRE UP EVENTS
  // =========================
  el.drawBtn.addEventListener("click", draw);
  el.resetBtn.addEventListener("click", reset);
  el.copyBtn.addEventListener("click", copyCurrent);

  el.category.addEventListener("change", () => {
    state.category = el.category.value;
    if(el.noRepeats.checked) reshuffleRemainingFromCurrentFilter();
    updateMeta();
    save();
  });

  el.search.addEventListener("input", () => {
    state.search = el.search.value;
    if(el.noRepeats.checked) reshuffleRemainingFromCurrentFilter();
    updateMeta();
    save();
  });

  el.noRepeats.addEventListener("change", () => {
    // When switching to no-repeats, build remaining from current filter
    if(el.noRepeats.checked) reshuffleRemainingFromCurrentFilter();
    updateMeta();
    save();
  });

  // =========================
  // 4) INIT
  // =========================
  load();
  initUI();

  // If remainingIds is empty, initialize it (especially first run)
  if(!Array.isArray(state.remainingIds) || state.remainingIds.length === 0){
    reshuffleRemainingFromCurrentFilter();
  }

  updateMeta();
  renderHistory();

  renderCard({
    title: "Ready.",
    category: "Deck",
    body: "Click Draw to pull something from your pool.",
    footer: "Tip: Use Category + Search to control what’s eligible.",
    rarity: "common"
  });

  save();
</script>
</body>
</html>
